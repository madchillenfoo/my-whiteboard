<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Whiteboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            overflow: hidden;
            background: #1a1a1a;
        }
        
        #toolbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .tool-group {
            display: flex;
            gap: 10px;
            align-items: center;
            background: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        label {
            color: white;
            font-size: 14px;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        input[type="color"] {
            width: 50px;
            height: 40px;
            border: 3px solid white;
            border-radius: 8px;
            cursor: pointer;
            background: none;
        }
        
        input[type="range"] {
            width: 120px;
            height: 6px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        select {
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            background: white;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        input[type="text"] {
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.9);
            font-size: 14px;
        }
        
        button {
            padding: 10px 20px;
            background: rgba(255,255,255,0.9);
            color: #667eea;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        button:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        button.active {
            background: #ff6b6b;
            color: white;
        }
        
        .tool-btn {
            width: 45px;
            height: 45px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: rgba(255,255,255,0.9);
        }
        
        .tool-btn.active {
            background: white;
            border: 3px solid #ffd700;
            transform: scale(1.1);
        }
        
        #canvas {
            display: block;
            background: white;
            cursor: crosshair;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }
        
        #userInfo {
            position: fixed;
            top: 90px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            min-width: 250px;
        }
        
        #userInfo h3 {
            margin-bottom: 10px;
            color: #667eea;
            font-size: 16px;
        }
        
        #username {
            width: 100%;
            margin-bottom: 15px;
        }
        
        #onlineUsers {
            color: #27ae60;
            font-weight: 700;
            font-size: 18px;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 8px;
            text-align: center;
        }
        
        #currentColor {
            width: 30px;
            height: 30px;
            border: 3px solid white;
            border-radius: 50%;
            display: inline-block;
            vertical-align: middle;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .size-display {
            color: white;
            font-weight: 700;
            min-width: 35px;
            text-align: center;
            font-size: 16px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        #clearBtn {
            background: #ff6b6b;
            color: white;
        }
        
        #clearBtn:hover {
            background: #ff5252;
        }
    </style>
</head>
<body>
    <div id="toolbar">
        <div class="tool-group">
            <label>Tool:</label>
            <button class="tool-btn active" data-tool="brush" title="Brush">üñåÔ∏è</button>
            <button class="tool-btn" data-tool="eraser" title="Eraser">üßπ</button>
            <button class="tool-btn" data-tool="fill" title="Fill Bucket">ü™£</button>
            <button class="tool-btn" data-tool="eyedropper" title="Eyedropper">üíß</button>
        </div>
        
        <div class="tool-group">
            <label>Color:</label>
            <input type="color" id="colorPicker" value="#000000">
            <span id="currentColor"></span>
        </div>
        
        <div class="tool-group">
            <label>Thickness:</label>
            <input type="range" id="brushSize" min="1" max="50" value="5">
            <span class="size-display" id="sizeDisplay">5</span>
        </div>
        
        <div class="tool-group">
            <label>Brush Style:</label>
            <select id="brushStyle">
                <option value="round">‚óè Round</option>
                <option value="square">‚ñ† Square</option>
                <option value="spray">‚ú¶ Spray</option>
            </select>
        </div>
        
        <button id="clearBtn">üóëÔ∏è Clear Canvas</button>
    </div>
    
    <div id="userInfo">
        <h3>üë§ User Settings</h3>
        <input type="text" id="username" placeholder="Enter name or @twitter" maxlength="30">
        <div id="onlineUsers">üë• Online: 1</div>
    </div>
    
    <canvas id="canvas"></canvas>

    <script type="module">
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        // IMPORTANT: Replace these values with YOUR Firebase config
        // Get this from Firebase Console > Project Settings > Your Apps > Web App
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, onValue, push, onDisconnect, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyC1MfaEohiAtPkH5bbxINqqkRoYEBZ4B6A",
            authDomain: "whiteboard-d6357.firebaseapp.com",
            databaseURL: "https://whiteboard-d6357-default-rtdb.firebaseio.com",
            projectId: "whiteboard-d6357",
            storageBucket: "whiteboard-d6357.firebasestorage.app",
            messagingSenderId: "124637106374",
            appId: "1:124637106374:web:081d50ffbf7b5dcda607c7"
        };
          
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // ============================================
        // CANVAS SETUP
        // ============================================
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        
        // Set canvas size
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight - 80;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // ============================================
        // DRAWING STATE
        // ============================================
        let currentTool = 'brush';
        let currentColor = '#000000';
        let brushSize = 5;
        let brushStyle = 'round';
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        
        // Generate unique user ID
        const userId = 'user_' + Math.random().toString(36).substr(2, 9);
        
        // ============================================
        // UI ELEMENTS
        // ============================================
        const toolButtons = document.querySelectorAll('.tool-btn');
        const colorPicker = document.getElementById('colorPicker');
        const currentColorDisplay = document.getElementById('currentColor');
        const brushSizeInput = document.getElementById('brushSize');
        const sizeDisplay = document.getElementById('sizeDisplay');
        const brushStyleSelect = document.getElementById('brushStyle');
        const clearBtn = document.getElementById('clearBtn');
        const usernameInput = document.getElementById('username');
        const onlineUsersDiv = document.getElementById('onlineUsers');
        
        // Update current color display
        function updateColorDisplay() {
            currentColorDisplay.style.backgroundColor = currentColor;
        }
        updateColorDisplay();
        
        // ============================================
        // TOOL SELECTION
        // ============================================
        toolButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                toolButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentTool = btn.dataset.tool;
                
                // Update cursor based on tool
                if (currentTool === 'eyedropper') {
                    canvas.style.cursor = 'crosshair';
                } else if (currentTool === 'fill') {
                    canvas.style.cursor = 'pointer';
                } else {
                    canvas.style.cursor = 'crosshair';
                }
            });
        });
        
        colorPicker.addEventListener('change', (e) => {
            currentColor = e.target.value;
            updateColorDisplay();
        });
        
        brushSizeInput.addEventListener('input', (e) => {
            brushSize = parseInt(e.target.value);
            sizeDisplay.textContent = brushSize;
        });
        
        brushStyleSelect.addEventListener('change', (e) => {
            brushStyle = e.target.value;
        });
        
        clearBtn.addEventListener('click', () => {
            if (confirm('Clear the entire canvas? This will affect all users!')) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                // Clear Firebase data
                set(ref(database, 'canvas'), null);
            }
        });
        
        // ============================================
        // USER PRESENCE SYSTEM
        // ============================================
        const userRef = ref(database, 'users/' + userId);
        set(userRef, { 
            online: true, 
            username: 'Anonymous',
            timestamp: Date.now()
        });
        
        // Remove user when they disconnect
        onDisconnect(userRef).remove();
        
        // Update username
        usernameInput.addEventListener('change', (e) => {
            let username = e.target.value.trim() || 'Anonymous';
            // Add @ symbol if user is entering Twitter handle without it
            if (username && username !== 'Anonymous' && !username.startsWith('@') && username.length < 20) {
                username = '@' + username;
                usernameInput.value = username;
            }
            set(userRef, { 
                online: true, 
                username: username,
                timestamp: Date.now()
            });
        });
        
        // Count online users
        onValue(ref(database, 'users'), (snapshot) => {
            const users = snapshot.val();
            const count = users ? Object.keys(users).length : 0;
            onlineUsersDiv.textContent = `üë• Online: ${count}`;
        });
        
        // ============================================
        // DRAWING FUNCTIONS
        // ============================================
        
        function drawLine(x1, y1, x2, y2, color, size, style, tool) {
            ctx.strokeStyle = tool === 'eraser' ? '#ffffff' : color;
            ctx.lineWidth = size;
            ctx.lineCap = style === 'square' ? 'square' : 'round';
            ctx.lineJoin = style === 'square' ? 'miter' : 'round';
            
            if (style === 'spray') {
                // Spray paint effect
                const distance = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
                const steps = Math.max(distance / 2, 1);
                
                for (let i = 0; i < steps; i++) {
                    const t = i / steps;
                    const x = x1 + (x2 - x1) * t;
                    const y = y1 + (y2 - y1) * t;
                    
                    for (let j = 0; j < 10; j++) {
                        const offsetX = (Math.random() - 0.5) * size * 2;
                        const offsetY = (Math.random() - 0.5) * size * 2;
                        ctx.fillStyle = color;
                        ctx.fillRect(x + offsetX, y + offsetY, 2, 2);
                    }
                }
            } else {
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
            }
        }
        
        function floodFill(startX, startY, fillColor) {
            startX = Math.floor(startX);
            startY = Math.floor(startY);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const targetColor = getPixelColor(imageData, startX, startY);
            const fillColorRgb = hexToRgb(fillColor);
            
            // Don't fill if colors match
            if (colorsMatch(targetColor, fillColorRgb)) return;
            
            const pixelsToCheck = [[startX, startY]];
            const checkedPixels = new Set();
            
            while (pixelsToCheck.length > 0) {
                const [x, y] = pixelsToCheck.pop();
                const key = `${x},${y}`;
                
                if (checkedPixels.has(key)) continue;
                if (x < 0 || x >= canvas.width || y < 0 || y >= canvas.height) continue;
                
                const currentColor = getPixelColor(imageData, x, y);
                
                if (!colorsMatch(currentColor, targetColor)) continue;
                
                setPixelColor(imageData, x, y, fillColorRgb);
                checkedPixels.add(key);
                
                // Add neighboring pixels
                pixelsToCheck.push([x + 1, y], [x - 1, y], [x, y + 1], [x, y - 1]);
            }
            
            ctx.putImageData(imageData, 0, 0);
        }
        
        function getPixelColor(imageData, x, y) {
            const index = (y * imageData.width + x) * 4;
            return [
                imageData.data[index],
                imageData.data[index + 1],
                imageData.data[index + 2],
                imageData.data[index + 3]
            ];
        }
        
        function setPixelColor(imageData, x, y, color) {
            const index = (y * imageData.width + x) * 4;
            imageData.data[index] = color[0];
            imageData.data[index + 1] = color[1];
            imageData.data[index + 2] = color[2];
            imageData.data[index + 3] = 255;
        }
        
        function hexToRgb(hex) {
            const bigint = parseInt(hex.slice(1), 16);
            return [(bigint >> 16) & 255, (bigint >> 8) & 255, bigint & 255];
        }
        
        function rgbToHex(r, g, b) {
            return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }
        
        function colorsMatch(a, b) {
            return a[0] === b[0] && a[1] === b[1] && a[2] === b[2] && a[3] === b[3];
        }
        
        // ============================================
        // CANVAS EVENTS
        // ============================================
        
        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }
        
        function getTouchPos(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: e.touches[0].clientX - rect.left,
                y: e.touches[0].clientY - rect.top
            };
        }
        
        function startDrawing(e) {
            e.preventDefault();
            isDrawing = true;
            
            const pos = e.touches ? getTouchPos(e) : getMousePos(e);
            lastX = pos.x;
            lastY = pos.y;
            
            if (currentTool === 'fill') {
                floodFill(pos.x, pos.y, currentColor);
                saveToFirebase(pos.x, pos.y, lastX, lastY, 'fill');
            } else if (currentTool === 'eyedropper') {
                const pixel = ctx.getImageData(Math.floor(pos.x), Math.floor(pos.y), 1, 1).data;
                currentColor = rgbToHex(pixel[0], pixel[1], pixel[2]);
                colorPicker.value = currentColor;
                updateColorDisplay();
            } else {
                drawLine(pos.x, pos.y, pos.x, pos.y, currentColor, brushSize, brushStyle, currentTool);
                saveToFirebase(pos.x, pos.y, pos.x, pos.y, 'start');
            }
        }
        
        function draw(e) {
            if (!isDrawing || currentTool === 'fill' || currentTool === 'eyedropper') return;
            e.preventDefault();
            
            const pos = e.touches ? getTouchPos(e) : getMousePos(e);
            
            drawLine(lastX, lastY, pos.x, pos.y, currentColor, brushSize, brushStyle, currentTool);
            saveToFirebase(lastX, lastY, pos.x, pos.y, 'draw');
            
            lastX = pos.x;
            lastY = pos.y;
        }
        
        function stopDrawing(e) {
            if (isDrawing) {
                isDrawing = false;
            }
        }
        
        // Mouse events
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseleave', stopDrawing);
        
        // Touch events for mobile
        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);
        
        // ============================================
        // FIREBASE SYNC
        // ============================================
        
        function saveToFirebase(x1, y1, x2, y2, action) {
            const drawRef = ref(database, 'canvas');
            push(drawRef, {
                x1, y1, x2, y2, action,
                color: currentColor,
                size: brushSize,
                tool: currentTool,
                style: brushStyle,
                timestamp: Date.now(),
                userId: userId
            });
        }
        
        // Listen for remote drawings
        let processedDraws = new Set();
        
        onValue(ref(database, 'canvas'), (snapshot) => {
            const draws = snapshot.val();
            if (!draws) return;
            
            const newDraws = [];
            
            Object.entries(draws).forEach(([key, data]) => {
                // Skip if already processed or from this user
                if (processedDraws.has(key) || data.userId === userId) return;
                
                newDraws.push({ key, data });
            });
            
            // Sort by timestamp to maintain drawing order
            newDraws.sort((a, b) => a.data.timestamp - b.data.timestamp);
            
            // Process new draws
            newDraws.forEach(({ key, data }) => {
                if (data.action === 'fill') {
                    floodFill(data.x1, data.y1, data.color);
                } else {
                    drawLine(data.x1, data.y1, data.x2, data.y2, data.color, data.size, data.style, data.tool);
                }
                processedDraws.add(key);
            });
        });
        
        // Clean up old data periodically (keep last 10000 draws)
        setInterval(() => {
            onValue(ref(database, 'canvas'), (snapshot) => {
                const draws = snapshot.val();
                if (!draws) return;
                
                const drawArray = Object.entries(draws);
                if (drawArray.length > 10000) {
                    drawArray.sort((a, b) => a[1].timestamp - b[1].timestamp);
                    const toRemove = drawArray.slice(0, drawArray.length - 10000);
                    toRemove.forEach(([key]) => {
                        remove(ref(database, 'canvas/' + key));
                    });
                }
            }, { onlyOnce: true });
        }, 60000); // Check every minute
        
        console.log('üé® Collaborative Whiteboard Ready!');
        console.log('üë• Share this URL with others to collaborate in real-time');
    </script>
</body>
</html>
